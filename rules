CC = gcc
CFLAGS = $(WARNINGS) -Werror -g
YACC = bison -y

-include $(TOP)/defs
-include $(TOP)/defs.$(HOST)
-include $(TOP)/defs.$(LAB)
-include $(TOP)/defs.$(ARCH)

INCLUDES = -I$(TOP)/include $(RSAREF_INC) $(ZEPHYR_INC) $(DB_INC) $(CGIC_INC)
DEFINES = -DGALE_CONF=\"$(GALE_CONF)\" -DSTDC_HEADERS

WARNINGS = -W -Wimplicit -Wreturn-type -Wunused -Wswitch -Wtrigraphs -Wformat \
	-Wchar-subscripts -Wparentheses

CPPFLAGS = $(INCLUDES) $(DEFINES)
LDLIBS = -L$(TOP)/lib -lgale $(RSAREF_LIB) $(ZEPHYR_LIB) $(DB_LIB) $(CGIC_LIB)

all::
	@make --no-print-directory subdirs TARGET=all
all:: $(BIN_TARGETS) $(LIB_TARGETS)

install::
	@make --no-print-directory subdirs TARGET=install
install:: $(BIN_TARGETS) $(LIB_TARGETS)
ifdef BIN_TARGETS
	@mkdir -p $(BIN_DIR)
	[ -z "$(BIN_TARGETS)" ] || cp $(BIN_TARGETS) $(BIN_DIR)
endif
ifdef LIB_TARGETS
	@mkdir -p $(LIB_DIR)
	[ -z "$(LIB_TARGETS)" ] || cp $(LIB_TARGETS) $(LIB_DIR)
endif
ifdef HEADERS
	@mkdir -p $(INC_DIR)
	[ -z "$(HEADERS)" ] || cp $(HEADERS) $(INC_DIR)
endif

clean::
	$(RM) *.o $(BIN_TARGETS) $(LIB_TARGETS)
	@make --no-print-directory subdirs TARGET=clean

subdirs:
	@for sub in $(SUBDIRS) "" ; do [ -z "$$sub" ] || make -C $$sub $(TARGET) || exit 1 ; done
