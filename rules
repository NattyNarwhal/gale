-include $(TOP)/defs

export SYS_DIR BIN_DIR SUID_DIR GALE_USER GALE_DOMAIN GALE_VERSION

ifndef GALE_VERSION
GALE_VERSION = $(shell cat $(TOP)/version)
endif

INCLUDES = -I$(TOP)/include -I$(TOP) $(RSAREF_INC)
DEFINES = -DGALE_VERSION=\"$(GALE_VERSION)\" -DSYS_DIR=\"$(SYS_DIR)\"

WARNINGS = -W -Wimplicit -Wreturn-type -Wunused -Wswitch -Wtrigraphs -Wformat \
	-Wchar-subscripts -Wparentheses

CFLAGS = $(CONF_CFLAGS) $(WARNINGS) -Werror
CPPFLAGS = $(INCLUDES) $(DEFINES) $(CONF_CPPFLAGS) $(CONF_DEFS)
LDFLAGS = -L$(TOP)/auth -L$(TOP)/lib $(CONF_LDFLAGS)
LIBS = -lgauth -lgale -lgauth -lgale $(RSAREF_LIB) $(CONF_LIBS)

all::
	@$(MAKE) --no-print-directory subdirs TARGET=all
all:: $(BIN_TARGETS) $(LIB_TARGETS) $(SUID_TARGETS)

install::
	@$(MAKE) --no-print-directory subdirs TARGET=install
install:: \
	$(addprefix $(BIN_DIR)/,$(BIN_TARGETS)) \
	$(addprefix $(SUID_DIR)/,$(SUID_TARGETS)) \
	$(addprefix $(LIB_DIR)/,$(LIB_TARGETS)) \
	$(addprefix $(INC_DIR)/,$(HEADERS))

clean::
	@echo rm: object files, executables, and libraries.
	@$(RM) *.o core \
		$(BIN_TARGETS) $(SUID_TARGETS) $(LIB_TARGETS) $(CLEAN_FILES)
	@$(MAKE) --no-print-directory subdirs TARGET=clean

relink::
	@$(MAKE) --no-print-directory subdirs TARGET=relink
	@$(RM) $(BIN_TARGETS) $(SUID_TARGETS) $(LIB_TARGETS)
relink:: $(BIN_TARGETS) $(LIB_TARGETS) $(SUID_TARGETS)

rebuild: clean all

subdirs:
	@for sub in $(SUBDIRS) "" ; do [ -z "$$sub" ] || $(MAKE) -C $$sub $(TARGET) || exit 1 ; done

%.o: %.c
	@echo $^ '->' $@
	@$(CC) $(CFLAGS) $(CPPFLAGS) -c $*.c -o $@

%: %.o
	@echo $^ '->' $@
	@$(CC) $(LDFLAGS) $^ -o $@ $(LIBS)

%: %.c
	@echo $^ '->' $@
	@$(CC) $(CFLAGS) $(CPPFLAGS) $*.c -o $@ $(LDFLAGS) $(LIBS)

%.a: %.o
	@echo $^ '->' $@
	@ar ru $@ $^
	@$(RANLIB) $@ || true

$(BIN_DIR)/%: % mkdir/$(BIN_DIR)
	@echo $* '->' $(BIN_DIR)
	@[ ! -x $@ ] || mv $@ $@.tmp.$$$$
	@$(INSTALL_PROGRAM) $* $(BIN_DIR)

ifneq ($(SUID_DIR),$(BIN_DIR))
$(SUID_DIR)/%: % mkdir/$(SUID_DIR)
	@echo $* '->' $(SUID_DIR)
	@[ ! -x $@ ] || mv $(SUID_DIR)/$* $(SUID_DIR)/$*.tmp.$$$$
	@$(INSTALL_PROGRAM) $* $(SUID_DIR)
	@echo $(SUID_DIR)/$* '=>' $(BIN_DIR)
	@$(RM) $(BIN_DIR)/$*
	@ln -s $(SUID_DIR)/$* $(BIN_DIR)/$*
endif

$(LIB_DIR)/%.a: %.a mkdir/$(LIB_DIR)
	@echo $*.a '->' $(LIB_DIR)
	@$(INSTALL_DATA) $*.a $(LIB_DIR)

$(INC_DIR)/%.h: %.h mkdir/$(INC_DIR)
	@echo $*.h '->' $(INC_DIR)
	@$(INSTALL_DATA) $*.h $(INC_DIR)

mkdir/%:
	@[ -d $* ] || (echo mkdir -p $* && mkdir -p $* && chmod 755 $*)
